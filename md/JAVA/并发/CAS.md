# CAS

Compare And Swap，是乐观锁的一个实现

CAS包含仨参数：内存位置（V）、旧的预期值（A）、新值（B）

当内存V上的值等于旧的预期值A的时候，就把V上的值由A修改为新值B，否则什么也不做，返回失败给调用者

因为CAS直接抛弃了锁，因此少掉了锁的竞争，保证线程安全的同时性能高了好多华莱士

## Unsafe

Java是没法直接操作内存的，因此在*sun.misc*包中，提供了一个*Unsafe*类来实现CAS

*Unsafe*里面的大部分方法都是*native*方法，这也就意味着它使用了本地方法。从源码中也看得出来*Unsafe*大概是直接通过指针操作内存

当然，正如类名所表达的意思，这个类是不安全的。但是JUC包中的CAS操作都是依赖于*Unsafe*类来完成

## 缺点

#### ABA问题

CAS在进行操作的时候，需要检查V里面的值是否和A相同，如果相同则改变

那么问题来了：如果一个值原来是A，被改成了B，后来又被改成了A。使用CAS时，检查的时候会发现它的值没有发生变化，或者说CAS无法发现这个值曾经发生过变化，但是这个值实际上已经被改过了。

这就是ABA问题

解决方式是在变量前面加上版本号，每次更新时版本号+1。这样能有效避免ABA问题

#### 循环时间长时开销大

一般CAS失败时采用的是自旋策略。那么在长时间自旋仍然不成功的时候，会造成很大的CPU开销

#### 只能保证一个共享变量的原子操作

好像没啥好解释的

只有一个共享变量的时候，CAS可以保证对它操作的原子性。但是有多个共享变量的时候，CAS就无法保证对这些变量的一些列操作下来是原子性的
